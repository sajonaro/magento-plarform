services:
  # LocalStack - AWS services emulation
  localstack:
    image: localstack/localstack:latest
    container_name: magento-localstack
    ports:
      - "4566:4566"            # LocalStack gateway
      - "4510-4559:4510-4559"  # External services port range
    environment:
      - SERVICES=s3,sqs,secretsmanager,ecr,rds,elasticache,iam
      - DEBUG=1
      - DATA_DIR=/var/lib/localstack
      - DOCKER_HOST=unix:///var/run/docker.sock
      - PERSISTENCE=1
      - AWS_DEFAULT_REGION=eu-west-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
    volumes:
      - localstack-data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - magento-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # K3s - Lightweight Kubernetes
  k3s:
    image: rancher/k3s:v1.28.5-k3s1
    container_name: magento-k3s
    privileged: true
    tmpfs:
      - /run
      - /var/run
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    ports:
      - "6443:6443"   # Kubernetes API
      - "80:80"       # HTTP
      - "443:443"     # HTTPS
      - "8080:8080"   # ArgoCD UI (when deployed)
    environment:
      - K3S_TOKEN=magento-k3s-token
      - K3S_KUBECONFIG_OUTPUT=/output/kubeconfig.yaml
      - K3S_KUBECONFIG_MODE=666
    volumes:
      - k3s-server:/var/lib/rancher/k3s
      - ./kubeconfig:/output
      - ./k3s-manifests:/var/lib/rancher/k3s/server/manifests/custom
    command:
      - server
      - --disable=traefik
      - --write-kubeconfig-mode=644
      - --tls-san=k3s
      - --tls-san=localhost
      - --tls-san=127.0.0.1
    networks:
      - magento-network
    healthcheck:
      test: ["CMD-SHELL", "test -f /var/lib/rancher/k3s/server/token"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s
    depends_on:
      localstack:
        condition: service_healthy

  # K3s Init - Initialize cluster with AWS connectivity to LocalStack
  k3s-init:
    image: amazon/aws-cli:latest
    container_name: magento-k3s-init
    volumes:
      - ./kubeconfig:/kubeconfig
      - ./init-scripts:/scripts
    environment:
      - AWS_ENDPOINT_URL=http://localstack:4566
      - AWS_DEFAULT_REGION=eu-west-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - KUBECONFIG=/kubeconfig/kubeconfig.yaml
    networks:
      - magento-network
    depends_on:
      k3s:
        condition: service_healthy
      localstack:
        condition: service_healthy
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Waiting for LocalStack to be ready..."
        sleep 10
        
        echo "Creating S3 buckets..."
        aws --endpoint-url=http://localstack:4566 s3 mb s3://magento-media || true
        aws --endpoint-url=http://localstack:4566 s3 mb s3://magento-backups || true
        aws --endpoint-url=http://localstack:4566 s3 mb s3://magento-logs-l2 || true
        
        echo "Creating SQS queues..."
        aws --endpoint-url=http://localstack:4566 sqs create-queue --queue-name magento-orders.fifo --attributes FifoQueue=true || true
        aws --endpoint-url=http://localstack:4566 sqs create-queue --queue-name magento-emails.fifo --attributes FifoQueue=true || true
        aws --endpoint-url=http://localstack:4566 sqs create-queue --queue-name magento-dlq.fifo --attributes FifoQueue=true || true
        
        echo "Creating Secrets Manager secrets..."
        aws --endpoint-url=http://localstack:4566 secretsmanager create-secret \
          --name magento/db/credentials \
          --secret-string '{"username":"magento","password":"magento123","host":"localhost","port":"3306","database":"magento"}' || true
        
        aws --endpoint-url=http://localstack:4566 secretsmanager create-secret \
          --name magento/redis/credentials \
          --secret-string '{"host":"redis","port":"6379","password":""}' || true
        
        echo "LocalStack initialization complete!"
        tail -f /dev/null

volumes:
  k3s-server:
    driver: local
  localstack-data:
    driver: local

networks:
  magento-network:
    driver: bridge